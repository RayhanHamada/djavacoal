name: Deploy to Cloudflare Workers (Production)

on:
    push:
        branches: [main]
    workflow_dispatch:

jobs:
    deploy:
        name: Deploy Production
        runs-on: ubuntu-latest
        environment:
            name: production
        env:
            NODE_ENV: production
            NEXTJS_ENV: production
            NEXT_TELEMETRY_DISABLED: "1"
            BETTER_AUTH_SECRET: ${{ vars.BETTER_AUTH_SECRET }}
            CLOUDFLARE_API_TOKEN: ${{ vars.CLOUDFLARE_API_TOKEN }}
            R2_ACCESS_KEY_ID: ${{ vars.R2_ACCESS_KEY_ID }}
            R2_SECRET_ACCESS_KEY: ${{ vars.R2_SECRET_ACCESS_KEY }}
            RESEND_API_KEY: ${{ vars.RESEND_API_KEY }}
            BETTER_AUTH_BASE_PATH: ${{ vars.BETTER_AUTH_BASE_PATH }}
            BETTER_AUTH_URL: ${{ vars.BETTER_AUTH_URL }}
            CLOUDFLARE_ACCOUNT_ID: ${{ vars.CLOUDFLARE_ACCOUNT_ID }}
            CLOUDFLARE_DATABASE_ID: ${{ vars.CLOUDFLARE_DATABASE_ID }}
            NEXT_PUBLIC_ASSET_URL: ${{ vars.NEXT_PUBLIC_ASSET_URL }}
            NEXT_PUBLIC_BASE_URL: ${{ vars.NEXT_PUBLIC_BASE_URL }}
            NEXT_PUBLIC_WHATSAPP_NUMBER: ${{ vars.NEXT_PUBLIC_WHATSAPP_NUMBER }}
            NEXT_PUBLIC_WHATSAPP_NAME: ${{ vars.NEXT_PUBLIC_WHATSAPP_NAME }}
            RECIPIENT_EMAIL: ${{ vars.RECIPIENT_EMAIL }}
            S3_API: ${{ vars.S3_API }}
            SENDER_EMAIL: ${{ vars.SENDER_EMAIL }}
        timeout-minutes: 15

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: Cache Bun and Next.js build
              uses: actions/cache@v4
              with:
                  # See here for caching with `yarn`, `bun` or other package managers https://github.com/actions/cache/blob/main/examples.md or you can leverage caching with actions/setup-node https://github.com/actions/setup-node
                  path: |
                      ~/.bun/install/cache
                      .next/cache
                      .open-next
                  # Generate a new cache whenever packages or source files change.
                  key: ${{ runner.os }}-nextjs-${{ hashFiles('**/bun.lockb') }}-${{ hashFiles('**/*.js', '**/*.jsx', '**/*.ts', '**/*.tsx') }}

            - name: Install dependencies
              run: bun install --frozen-lockfile

            - name: Build artifact
              run: bun run cf:build:production

            - name: Deploy for cloudflare
              run: bun run cf:deploy:production
